<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô BOOBUN Phit'lok</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: 'Kanit', sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
    .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
    .btn-in { background: #28a745; }
    #status-msg { color: #666; font-size: 0.9rem; margin-top: 10px; }
  </style>
</head>
<body>

<div class="card">
  <img id="userImg" width="80" style="border-radius: 50%; display: none;">
  <h2 id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2>
  <hr>
  <button class="btn btn-in" onclick="processAttendance('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
  <button class="btn" style="background:#dc3545" onclick="processAttendance('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</button>
  <p id="status-msg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
</div>

<script>
const LIFF_ID =  '2008726712-TyWc8pGY';//‡πÉ‡∏™‡πà_LIFF_ID_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwPIOor4kKun6OBn2LD1imBdIT5_HyrfzByGiJkXH8FPC-aMm--1LN-8k22EQvriLqj_Q/exec';//‡πÉ‡∏™‡πà_GAS_URL_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const OFFICE_LAT = 16.4409792; // ‡πÉ‡∏™‡πà‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
const OFFICE_LNG = 100.2679006; // ‡πÉ‡∏™‡πà‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
const ALLOWED_DISTANCE = 200; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 200 ‡πÄ‡∏°‡∏ï‡∏£

async function main() {
  try {
    await liff.init({ liffId: LIFF_ID });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Token ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      try {
        const profile = await liff.getProfile();
        document.getElementById('userName').innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ " + profile.displayName;
        document.getElementById('userImg').src = profile.pictureUrl;
        document.getElementById('userImg').style.display = 'inline-block';
        document.getElementById('status-msg').innerText = "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
      } catch (profileError) {
        // ‡∏´‡∏≤‡∏Å getProfile ‡∏û‡∏±‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Token ‡∏ñ‡∏π‡∏Å Revoke ‡πÉ‡∏´‡πâ Logout ‡πÅ‡∏•‡πâ‡∏ß Login ‡πÉ‡∏´‡∏°‡πà
        console.error("Token error, logging out...");
        liff.logout();
        liff.login();
      }
    }
  } catch (err) {
    console.error("Init Error:", err);
    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Access Token ‡∏ï‡∏≠‡∏ô Init ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á Login ‡πÉ‡∏´‡∏°‡πà
    if (err.message.includes("revoked")) {
      liff.login();
    } else {
      document.getElementById('status-msg').innerText = "Init Error: " + err.message;
    }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (‡πÄ‡∏°‡∏ï‡∏£)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function processAttendance(status) {
  const msgEl = document.getElementById('status-msg');
  msgEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏û‡∏¥‡∏Å‡∏±‡∏î...";

  try {
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const uLat = pos.coords.latitude;
      const uLng = pos.coords.longitude;
      const distance = getDistance(uLat, uLng, OFFICE_LAT, OFFICE_LNG);
      const roundedDistance = Math.round(distance);
          /*
            // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ---
            if (distance > ALLOWED_DISTANCE) {
                msgEl.innerText = "‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà!";
                alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ${roundedDistance} ‡πÄ‡∏°‡∏ï‡∏£\n(‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${ALLOWED_DISTANCE} ‡πÄ‡∏°‡∏ï‡∏£)`);
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ GAS ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á Flex
            }
            */
      msgEl.innerText = "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      const profile = await liff.getProfile();
      const context = liff.getContext();
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ß‡πà‡∏≤‡∏á‡πÜ ‡πÅ‡∏ó‡∏ô)
      const userPicture = profile.pictureUrl || "https://img.icons8.com/bubbles/2x/user.png";

      const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        status: status,
        location: `${uLat},${uLng}`,
        distance: Math.round(distance)
      };

      // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡πà‡∏á Flex Message ---
      if (liff.isInClient() && (context.type === 'group' || context.type === 'room' || context.type === 'utou')) {
        msgEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°...";
       const flexMessage = {
              type: "flex",
              altText: `üìç ${profile.displayName} ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${status} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
              contents: {
                "type": "bubble",
                "size": "mega",
                "header": {
                  "type": "box",
                  "layout": "vertical",
                  "contents": [
                    {
                      "type": "box",
                      "layout": "horizontal",
                      "contents": [
                        {
                          "type": "text",
                          "text": "ATTENDANCE RECORD",
                          "weight": "bold",
                          "color": "#ffffff",
                          "size": "sm"
                        }
                      ]
                    }
                  ],
                  "backgroundColor": "#28a745",
                  "paddingTop": "15px",
                  "paddingBottom": "15px"
                },
                "body": {
                  "type": "box",
                  "layout": "vertical",
                  "contents": [
                    {
                      "type": "box",
                      "layout": "horizontal",
                      "contents": [
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "image",
                              "url": "https://www.w3schools.com/howto/img_avatar.png",
                              "aspectMode": "cover",
                              "size": "full"
                            }
                          ],
                          "cornerRadius": "100px",
                          "width": "60px",
                          "height": "60px"
                        },
                        {
                          "type": "box",
                          "layout": "vertical",
                          "contents": [
                            {
                              "type": "text",
                              "text": profile.displayName,
                              "weight": "bold",
                              "size": "xl",
                              "margin": "sm"
                            },
                            {
                              "type": "text",
                              "text": "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                              "size": "xs",
                              "color": "#888888"
                            }
                          ],
                          "margin": "lg"
                        }
                      ]
                    },
                    {
                      "type": "separator",
                      "margin": "xl"
                    },
                    {
                      "type": "box",
                      "layout": "vertical",
                      "margin": "xl",
                      "spacing": "sm",
                      "contents": [
                        {
                          "type": "box",
                          "layout": "horizontal",
                          "contents": [
                            { "type": "text", "text": "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                            { "type": "text", "text": status, "weight": "bold", "size": "sm", "color": status === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? "#28a745" : "#dc3545", "flex": 4 }
                          ]
                        },
                        {
                          "type": "box",
                          "layout": "horizontal",
                          "contents": [
                            { "type": "text", "text": "‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                            { "type": "text", "text": new Date().toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'short' }), "size": "sm", "color": "#444444", "flex": 4 }
                          ]
                        },
                        {
                          "type": "box",
                          "layout": "horizontal",
                          "contents": [
                            { "type": "text", "text": "‡∏û‡∏¥‡∏Å‡∏±‡∏î", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                            { "type": "text", "text": "üìç ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î", "size": "sm", "color": "#17a2b8", "flex": 4 }
                          ]
                        }
                      ]
                    }
                  ]
                },
                "footer": {
                  "type": "box",
                  "layout": "vertical",
                  "contents": [
                    {
                      "type": "text",
                      "text": "HR AUTOMATION SYSTEM",
                      "size": "xxs",
                      "color": "#aaaaaa",
                      "align": "center"
                    }
                  ]
                },
                "styles": {
                  "footer": {
                    "separator": true
                  }
                }
              }
              };

        try {
          
          await liff.sendMessages([flexMessage]);
        } catch (e) {
          console.error("Flex Message Error:", e);
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á Flex ‡πÑ‡∏î‡πâ: " + e.message); // ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏¥‡∏î Scopes
        }
      }

      // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets ---
      msgEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });

      msgEl.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
      setTimeout(() => { liff.closeWindow(); }, 1500);

    }, (err) => {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠");
    });
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
}

main();
</script>
</body>
</html>


























